module pipeline_register #(
    parameter WIDTH = 32
)(
    input  logic             clk,
    input  logic             rst_n,

    // Input Interface (Upstream)
    input  logic [WIDTH-1:0] in_data,
    input  logic             in_valid,
    output logic             in_ready,

    // Output Interface (Downstream)
    output logic [WIDTH-1:0] out_data,
    output logic             out_valid,
    input  logic             out_ready
);

    // Internal Registers
    logic [WIDTH-1:0] data_reg;
    logic             valid_reg;

    
    assign in_ready = (!valid_reg) || out_ready;

    always_ff @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            valid_reg <= 1'b0;
            data_reg  <= '0;
        end else begin
            // If we are ready and valid data is arriving, capture it.
            if (in_ready) begin
                if (in_valid) begin
                    valid_reg <= 1'b1;
                    data_reg  <= in_data;
                end else if (out_ready) begin
                    // If input is NOT valid, but we just pushed data downstream,
                    // we become empty.
                    valid_reg <= 1'b0;
                end
            end
        end
    end

    
    assign out_data  = data_reg;
    assign out_valid = valid_reg;

endmodule
